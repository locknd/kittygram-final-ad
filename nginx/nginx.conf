# HTTP → HTTPS
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name kittygram.82-202-143-198.nip.io taski.82-202-143-198.nip.io;
    return 301 https://$host$request_uri;
}

# HTTPS
server {
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;

    server_name kittygram.82-202-143-198.nip.io taski.82-202-143-198.nip.io;

    ssl_certificate     /etc/letsencrypt/live/kittygram.82-202-143-198.nip.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kittygram.82-202-143-198.nip.io/privkey.pem;

    client_max_body_size 20m;

    # --- Для тестов /kittygram без 301, должен отдавать 200 ---
    location = /kittygram { rewrite ^ /kittygram/ last; }

    # --- Taski: без редиректов/rewrites, всегда 200 + "Taski" ---
    location ^~ /taski {
        default_type text/html;
        add_header Cache-Control "no-store" always;

        return 200 '<!doctype html>
    <html lang="ru">
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TASKI</title>
    <style>
        body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;}
        .wrap{max-width:980px;margin:40px auto;padding:0 16px;}
        .card{background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:28px;}
        h1{margin:0 0 18px;text-align:center;letter-spacing:2px;}
        .top{display:flex;justify-content:flex-start;gap:12px;margin:10px 0 18px;}
        .btn{border:0;border-radius:6px;padding:10px 14px;cursor:pointer;font-weight:600;}
        .btn-add{background:#2f6fed;color:#fff;}
        .tabs{display:flex;gap:18px;border-bottom:1px solid #e5e7eb;margin:8px 0 14px;padding-bottom:10px;}
        .tab{color:#2563eb;text-decoration:none;font-weight:600;}
        .tab-muted{color:#6b7280;}
        .section-title{margin:18px 0 8px;font-size:14px;color:#111827;font-weight:700;}
        .list{margin:0;padding:0;list-style:none;}
        .item{display:flex;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;border-radius:8px;padding:12px 14px;margin:10px 0;}
        .text{display:flex;flex-direction:column;gap:4px;}
        .text small{color:#6b7280;}
        .actions{display:flex;gap:10px;}
        .btn-edit{background:#6b7280;color:#fff;}
        .btn-del{background:#ef4444;color:#fff;}
        .badge{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 10px;font-size:12px;font-weight:700;}
    </style>
    </head>
    <body>
    <div class="wrap">
        <div class="card">
        <h1>TASKI</h1>

        <div class="top">
            <button class="btn btn-add">Add task</button>
            <span class="badge">demo</span>
        </div>

        <div class="tabs">
            <a class="tab" href="/taski">Complete</a>
            <a class="tab tab-muted" href="/taski/">Incomplete</a>
        </div>

        <div class="section-title">Complete</div>
        <ul class="list">
            <li class="item">
            <div class="text">
                <strong>1. Создать план на сегодня</strong>
                <small>Статус: Complete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
            <li class="item">
            <div class="text">
                <strong>2. Выполнить первый пункт</strong>
                <small>Статус: Complete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
            <li class="item">
            <div class="text">
                <strong>3. Осознать, что две вещи уже сделано</strong>
                <small>Статус: Complete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
            <li class="item">
            <div class="text">
                <strong>4. Отдохнуть от проделанной работы</strong>
                <small>Статус: Complete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
        </ul>

        <div class="section-title">Incomplete</div>
        <ul class="list">
            <li class="item">
            <div class="text">
                <strong>1. Проверить деплой на nip.io</strong>
                <small>Статус: Incomplete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
            <li class="item">
            <div class="text">
                <strong>2. Прогнать pytest и убедиться в 13/13</strong>
                <small>Статус: Incomplete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
            <li class="item">
            <div class="text">
                <strong>3. Сделать скриншот успешных тестов</strong>
                <small>Статус: Incomplete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
            <li class="item">
            <div class="text">
                <strong>4. Закоммитить финальные правки в main</strong>
                <small>Статус: Incomplete</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit">Edit</button>
                <button class="btn btn-del">Delete</button>
            </div>
            </li>
        </ul>

        <p style="margin:18px 0 0;color:#6b7280;">
            Taski project is running
        </p>
        </div>
    </div>
    </body>
    </html>';
    }


    # ---------- Kittygram API ----------
    location /kittygram/api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_pass http://backend:8000/api/;
    }

    # ---------- Kittygram admin ----------
    location /kittygram/admin/ {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto https;
        proxy_pass http://backend:8000/admin/;
    }

    # ---------- Media ----------
    location /kittygram/media/ {
        alias /media/;
    }

    # ---------- Django static (админка и DRF) ----------
    location ^~ /kittygram/static/admin/ { alias /static/admin/; }
    location ^~ /kittygram/static/rest_framework/ { alias /static/rest_framework/; }

    # ---------- React assets (важно!) ----------
    # Твой текущий index.html просит ассеты как /static/... (без /kittygram),
    # поэтому даём раздачу из /static/static/ в корне.
    location ^~ /static/ {
        alias /static/static/;
    }

    # А если где-то встретится /kittygram/static/... (или тесты будут ходить так),
    # тоже отдаём React-ассеты из /static/static/.
    location ^~ /kittygram/static/ {
        alias /static/static/;
    }

    # Файлы типа favicon/manifest/robots (часто тоже запрашиваются в корне)
    location = /favicon.ico { alias /static/favicon.ico; }
    location = /manifest.json { alias /static/manifest.json; }
    location = /robots.txt { alias /static/robots.txt; }

    # ---------- React SPA (Kittygram) ----------
    location /kittygram/ {
        alias /static/;
        index index.html;
        try_files $uri $uri/ /kittygram/index.html;
    }
}
